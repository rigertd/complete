/**
 * @file This file contains the functions and symbols required to display charts for the Child Growth Tracker website.
 * @author David Rigert
 * @copyright 2015 David Rigert
 */
if(typeof GrowthTracker=="undefined"){var GrowthTracker={};}if(typeof GrowthTracker.Chart=="undefined"){GrowthTracker.Chart={};}google.load("visualization","1",{packages:["corechart"]});google.setOnLoadCallback(function(){GrowthTracker.Chart.loaded=true;});window.onload=function(){var H=document.getElementById("newButton");var I=document.getElementById("addButton");var B=document.getElementById("cancelButton");var D=document.getElementById("deleteButton");var C=document.getElementById("addDataButton");var F=document.getElementById("saveDataButton");var z=document.getElementById("cancelDataButton");var s=document.getElementById("selectProfileForm");var E=document.getElementById("navButtonForm");var w=document.getElementById("newProfileForm");var u=document.getElementById("addDataForm");var G=document.getElementById("profile");var x=document.getElementById("chartType");var J=document.getElementById("chartDiv");var y=document.getElementById("profileName");var v=document.getElementById("profileDob");var A=document.getElementById("profileGender");var t=document.getElementById("welcome");w.style.display="none";u.style.display="none";C.onclick=function(){if(GrowthTracker.Chart.validateProfile()){GrowthTracker.Chart.setUnitSelector();GrowthTracker.Chart.showForm(u);GrowthTracker.Chart.hideForm(E);GrowthTracker.Chart.hideForm(w);}else{return false;}};z.onclick=function(){GrowthTracker.Chart.hideForm(u);GrowthTracker.Chart.showForm(E);};F.onclick=function(){if(GrowthTracker.Chart.validateProfile()){GrowthTracker.Chart.addCheckupData();}else{return false;}};G.onchange=function(){if(GrowthTracker.validateSelect(this,"You must select a profile.")){if(x.value){t.style.display="none";GrowthTracker.Chart.loadChart();}else{if(GrowthTracker.Chart.chart){GrowthTracker.Chart.chart.clearChart();t.style.display="";}}}else{if(GrowthTracker.Chart.chart){GrowthTracker.Chart.chart.clearChart();t.style.display="";}}};x.onchange=function(){if(GrowthTracker.validateSelect(this,"You must select a chart type.")){GrowthTracker.Chart.setUnitSelector();if(G.value){t.style.display="none";GrowthTracker.Chart.loadChart();}else{if(GrowthTracker.Chart.chart){GrowthTracker.Chart.chart.clearChart();t.style.display="";}}}else{if(GrowthTracker.Chart.chart){GrowthTracker.Chart.chart.clearChart();t.style.display="";}}};H.onclick=function(){GrowthTracker.hideErrors(s);GrowthTracker.Chart.hideForm(u);GrowthTracker.Chart.hideForm(E);GrowthTracker.Chart.showForm(w);};I.onclick=GrowthTracker.Chart.addNewProfile;y.onblur=GrowthTracker.validateElement;v.onblur=GrowthTracker.validateElement;A.onchange=function(){GrowthTracker.validateSelect(this,"You must select a gender.");};B.onclick=function(){GrowthTracker.Chart.hideForm(w);GrowthTracker.Chart.showForm(E);};D.onclick=function(){if(GrowthTracker.Chart.removeProfile()){GrowthTracker.Chart.hideForm(w);GrowthTracker.Chart.showForm(E);}return false;};};GrowthTracker.Chart.showForm=function(b){b.style.display="";};GrowthTracker.Chart.hideForm=function(b){b.style.display="none";GrowthTracker.clearForm(b);};GrowthTracker.Chart.setLengthUnits=function(d){while(d.hasChildNodes()){d.removeChild(d.lastChild);}var c=new Option("value","in");c.textContent="Inches";d.appendChild(c);c=new Option("value","cm");c.textContent="Centimeters";d.appendChild(c);};GrowthTracker.Chart.setWeightUnits=function(d){while(d.hasChildNodes()){d.removeChild(d.lastChild);}var c=new Option("value","lb");c.textContent="Pounds";d.appendChild(c);c=new Option("value","kg");c.textContent="Kilograms";d.appendChild(c);};GrowthTracker.Chart.setUnitSelector=function(){var f=document.getElementById("dataUnit");var d=document.getElementById("dataEntry");var e=document.getElementById("chartType");switch(e.options[e.selectedIndex].value){case"length":GrowthTracker.Chart.setLengthUnits(f);d.placeholder="Body Length";f.value=docCookies.getItem("lengthUnit")||"in";f.onchange=function(){docCookies.setItem("lengthUnit",f.value,Infinity);};break;case"weight":GrowthTracker.Chart.setWeightUnits(f);d.placeholder="Weight";f.value=docCookies.getItem("weightUnit")||"lb";f.onchange=function(){docCookies.setItem("weightUnit",f.value,Infinity);};break;case"head":GrowthTracker.Chart.setLengthUnits(f);d.placeholder="Head Circumference";f.value=docCookies.getItem("headUnit")||"in";f.onchange=function(){docCookies.setItem("headUnit",f.value,Infinity);};break;}};window.onresize=function(){if(GrowthTracker.Chart.options){GrowthTracker.Chart.options.width=GrowthTracker.Chart.calculateWidth();GrowthTracker.Chart.options.height=GrowthTracker.Chart.options.width*0.8;GrowthTracker.Chart.options.chartArea.width=GrowthTracker.Chart.options.width*0.9-80;GrowthTracker.Chart.chart.draw(GrowthTracker.Chart.view,GrowthTracker.Chart.options);}};GrowthTracker.Chart.loadChart=function(){var c=document.getElementById("newProfileForm");var d=document.getElementById("navButtonForm");GrowthTracker.Chart.hideForm(c);GrowthTracker.Chart.showForm(d);GrowthTracker.clearForm(c);GrowthTracker.Chart.getPercentileData();};GrowthTracker.Chart.removeProfile=function(){var h=document.getElementById("profile");var f=h.options[h.selectedIndex].value;if(!GrowthTracker.validateSelect(h,"You must select a profile.")){return false;}if(!confirm("Are you sure you want to remove the profile "+h.options[h.selectedIndex].text+"? This operation cannot be undone.")){return false;}var e="chart.php?action=delete&profile="+f;var g=new XMLHttpRequest();g.onreadystatechange=function(){if(this.readyState===4){var c=JSON.parse(this.responseText);if(c.success=="true"){var a=document.getElementById("newProfileForm");var b=document.getElementById("navButtonForm");GrowthTracker.Chart.hideForm(a);GrowthTracker.Chart.showForm(b);GrowthTracker.clearForm(a);GrowthTracker.Chart.refreshProfiles();}else{alert(c.message);}}};g.open("GET",e);g.send();return true;};GrowthTracker.Chart.addCheckupData=function(){var r=document.getElementById("addDataForm");var m=document.getElementById("addDataButton");var n=document.getElementById("profile").value;var l=document.getElementById("chartType").value;var p=document.getElementById("dataMonths");var o=document.getElementById("dataEntry");var k=document.getElementById("dataUnit");if(!GrowthTracker.Chart.validateDataForm()){return false;}var q="chart.php?action=data&profile="+n+"&mo="+p.value;switch(l){case"length":q+="&l="+o.value+"&lu="+k.value;break;case"weight":q+="&w="+o.value+"&wu="+k.value;break;case"head":q+="&hc="+o.value+"&hcu="+k.value;break;}var j=new XMLHttpRequest();j.onreadystatechange=function(){if(this.readyState===4){var b=JSON.parse(this.responseText);if(b.success=="false"){alert(b.message);return false;}var a=document.getElementById("navButtonForm");GrowthTracker.Chart.hideForm(r);GrowthTracker.Chart.showForm(a);if(l){GrowthTracker.Chart.getPercentileData();}}};j.open("GET",q);j.send();};GrowthTracker.Chart.validateDataForm=function(){var e=document.getElementById("dataMonths");var f=document.getElementById("dataEntry");var d=GrowthTracker.Chart.validateProfile();d=GrowthTracker.validateElement(e)&&d;d=GrowthTracker.validateElement(f)&&d;return d;};GrowthTracker.Chart.refreshProfiles=function(){var j=document.getElementById("profile");var g=document.getElementById("addDataForm");var i=document.getElementById("welcome");var f="chart.php?action=profiles";var h=new XMLHttpRequest();h.onreadystatechange=function(){if(this.readyState===4){var a=JSON.parse(this.responseText);while(j.options.length>1){j.removeChild(j.lastChild);}a.forEach(function(c){var b=new Option("value",c.id);b.textContent=c.name+" ("+c.dob+")";j.appendChild(b);});if(GrowthTracker.Chart.chart){GrowthTracker.Chart.chart.clearChart();}GrowthTracker.hideForm(g);i.style.display="";}};h.open("GET",f);h.send();};GrowthTracker.Chart.addNewProfile=function(){var h=document.getElementById("profileName");var j=document.getElementById("profileDob");var m=document.getElementById("profileGender");var n=document.getElementById("newProfileForm");var l=GrowthTracker.validateElement(h);l=GrowthTracker.validateElement(j)&&l;l=GrowthTracker.validateSelect(m,"You must select a gender.")&&l;if(!l){return false;}var i="chart.php?action=new&profileName="+encodeURIComponent(h.value)+"&profileDob="+encodeURIComponent(j.value)+"&profileGender="+m.value;var k=new XMLHttpRequest();k.onreadystatechange=function(){if(this.readyState===4){var b=JSON.parse(this.responseText);if(b.success=="true"){var a=document.getElementById("navButtonForm");GrowthTracker.Chart.refreshProfiles();GrowthTracker.Chart.hideForm(n);GrowthTracker.Chart.showForm(a);}else{alert(b.message);}}};k.open("GET",i);k.send();return true;};GrowthTracker.Chart.prepareData=function(f){var h,e;var g=new google.visualization.DataTable();g.addColumn("string","Age in Months");g.addColumn("number","99.9th");g.addColumn("number","99th");g.addColumn("number","97th");g.addColumn("number","95th");g.addColumn("number","90th");g.addColumn("number","85th");g.addColumn("number","75th");g.addColumn("number","50th");g.addColumn("number","25th");g.addColumn("number","15th");g.addColumn("number","10th");g.addColumn("number","5th");g.addColumn("number","3rd");g.addColumn("number","1st");g.addColumn("number","0.1th");g.addColumn("number","Actual");for(h=0;h<f.length;++h){f[h][0]=String(f[h][0]);for(e=1;e<f[h].length;++e){f[h][e]=parseFloat(f[h][e])||null;}}g.addRows(f);return g;};GrowthTracker.Chart.validateProfile=function(){var d=document.getElementById("chartType");var c=document.getElementById("profile");GrowthTracker.validateSelect(d,"You must select a chart type.");GrowthTracker.validateSelect(c,"You must select a profile.");return d.options[d.selectedIndex].value&&c.options[c.selectedIndex].value;};GrowthTracker.Chart.getPercentileData=function(){var i=document.getElementById("chartType");var k=i.options[i.selectedIndex].value;var m=i.options[i.selectedIndex].text;var l=document.getElementById("profile");var h=l.options[l.selectedIndex].value;if(!GrowthTracker.Chart.validateProfile()){return false;}var n="chart.php?action=chart&profile="+h+"&type="+k;var j=new XMLHttpRequest();j.onreadystatechange=function(){if(this.readyState===4){var a=JSON.parse(this.responseText);GrowthTracker.Chart.data=GrowthTracker.Chart.prepareData(a);if(!GrowthTracker.Chart.loaded){return;}GrowthTracker.Chart.buildChart(k,m);}};j.open("GET",n);j.send();};GrowthTracker.Chart.buildChart=function(j,g){var h=document.getElementById("chartDiv");var f=GrowthTracker.Chart.calculateWidth();var i=j=="weight"?"Kilograms":"Centimeters";GrowthTracker.Chart.view=new google.visualization.DataView(GrowthTracker.Chart.data);GrowthTracker.Chart.view.hideColumns([1,4,6,10,12,15]);GrowthTracker.Chart.options={title:g+" Percentiles",curveType:"function",width:f,height:f*0.8,chartArea:{left:50,top:25,width:f*0.9-80,height:"80%"},interpolateNulls:true,series:{0:{targetAxisIndex:0,lineWidth:1},1:{targetAxisIndex:0,lineWidth:1},2:{targetAxisIndex:0,lineWidth:1},3:{targetAxisIndex:0,lineWidth:1},4:{targetAxisIndex:0,lineWidth:1},5:{targetAxisIndex:0,lineWidth:1},6:{targetAxisIndex:0,lineWidth:1},7:{targetAxisIndex:0,lineWidth:1},8:{targetAxisIndex:0,lineWidth:1},9:{targetAxisIndex:0,pointShape:"circle",pointSize:5,color:"black"}},hAxis:{showTextEvery:3},hAxes:{0:{title:"Age in Months"}},vAxes:{0:{title:g+" in "+i}}};GrowthTracker.Chart.chart=new google.visualization.LineChart(h);GrowthTracker.Chart.chart.draw(GrowthTracker.Chart.view,GrowthTracker.Chart.options);};GrowthTracker.Chart.calculateWidth=function(){var b=document.getElementById("chartDiv");return b.parentNode.clientWidth*0.99;};